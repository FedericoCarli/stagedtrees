---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# stagedtrees

[![stagedtrees](https://www.r-pkg.org/badges/version/stagedtrees)](https://cran.r-project.org/package=stagedtrees)
[![Build Status](https://travis-ci.com/gherardovarando/stagedtrees.svg?branch=master)](https://travis-ci.com/gherardovarando/stagedtrees)
 [![Coverage status](https://codecov.io/gh/gherardovarando/stagedtrees/branch/master/graph/badge.svg)](https://codecov.io/github/gherardovarando/stagedtrees?branch=master)
 [![](https://cranlogs.r-pkg.org/badges/stagedtrees)](https://cran.r-project.org/package=stagedtrees)
 
##### (almost) v2.0.0

The current version of `stagedtrees` available on github is a 
major update over the previous version (1.0.2). The update will 
almost surely break any code written with v1.0.2. 
Functions naming and functions parameters have been updated to
simplify user experience. 
Check the [complete changelog](NEWS.md) for details.

##### Preprint

F Carli, M Leonelli, E Riccomagno, G Varando, The R Package stagedtrees for Structural Learning of Stratified Staged Trees, 2020
[arXiv:2004.06459](https://arxiv.org/abs/2004.06459)

```
@misc{2004.06459,
Author = {Federico Carli and Manuele Leonelli and Eva Riccomagno and Gherardo Varando},
Title = {The R Package stagedtrees for Structural Learning of Stratified Staged Trees},
Year = {2020},
Eprint = {arXiv:2004.06459},
}
```

### Overview 

`stagedtrees` is a package that implements staged event trees, a probability
model for discrete random variables.   

### Installation 
  
```{r, eval = FALSE}
#stable version from CRAN 
install.packages("stagedtrees")

#development version from github
# install.packages("devtools")
devtools::install_github("gherardovarando/stagedtrees")
```

### Usage

```{r}
library("stagedtrees")
```

With the `stagedtrees` package it is possible to fit (stratified) staged 
event trees to data, use them to compute probabilities, make predictions, 
visualize and compare different models. 


#### Creating the model

A staged event tree object (`sevt` class) can be created with the function
`staged_ev_tree`, or with the functions `indep` and `full`. In general we create a staged event tree from data 
in a `data.frame` or `table` object. 

```{r example}
# Load the PhDArticles data
data("PhDArticles")

# Independence model 
mod_indep <- indep(PhDArticles, lambda = 1)
mod_indep

# Full (saturated) model
mod_full <- full(PhDArticles, lambda = 1) 
mod_full

# Full model with not-observed situations joined in NA stages
mod_full0 <- full(PhDArticles, join = TRUE, lambda = 1)
mod_full0
```

#### Model selection

`stagedtrees` implements methods to perform automatic model selection. All methods can be initialized from an arbitrary staged tree object. 

##### Score methods

This methods perform optimization for a given score 
using different heuristics. 

* **Hill-Climbing** `hc(object, score, max_iter, scope, ignore, trace)`
```{r}
mod1 <- hc(mod_indep)
mod1
```
* **Backward Hill-Climbing** `bhc(object, score, max_iter, scope, ignore, trace)`
```{r}
mod2 <- bhc(mod_full)
mod2
```
* **Backward Fast Hill-Climbing** 
`fbhc(object, score, max_iter, scope, ignore, trace)`
```{r}
mod3 <- fbhc(mod_full, score = function(x) -BIC(x))
mod3
```


##### Distance methods

* **Backward Joining** `bj(object, distance, thr, trace, ...)`
```{r}
mod4 <- bj(mod_full)
mod4
```

##### Clustering methods

* **Hierarchical Clustering** `stages_hclust(object, distance, k, method, ignore, limit, scope)`
```{r}
mod5 <- stages_hclust(mod_full0,
                    k = 2, 
                    distance = "totvar",
                   method = "mcquitty", 
                   ignore = "NA")
mod5
```

* **K-Means Clustering** `stages_kmeans(object, k, algorithm, ignore, limit, scope, nstart)`
```{r}
mod6 <- stages_kmeans(mod_full0,
                    k = 2, 
                   algorithm = "Hartigan-Wong", 
                   ignore = "NA")
mod6
```

#### Combining model selections with `%>%`

The pipe operator from the `magrittr` package can be used to combine
easily various model selection algorithms and to specify models easily. 

```{r}
library(magrittr)
model <- PhDArticles %>% full(lambda = 1) %>% 
           stages_hclust %>% hc

## extract a sub_tree and join two stages
sub_model <- model %>% subtree(path = c(">2"))  %>%  
              join_stages("Mentor", "1", "2")
```


#### Probabilities, predictions and sampling

##### Marginal probabilities

Obtain marginal probabilities with the  `prob` function.
```{r}
# estimated probability of c(Gender = "male", Married = "yes")
# using different models
prob(mod_indep, c(Gender = "male", Married = "yes")) 
prob(mod3, c(Gender = "male", Married = "yes"))
```

Or for a  `data.frame` of observations:

```{r}
obs <- expand.grid(mod_full$tree[c(2,3,5)])
p <- prob(mod2, obs)
cbind(obs, P = p)
```

##### Predictions

A staged event tree object can be used to make predictions with the
`predict` method. The class variable can be specified, otherwise the 
first variable (root) in the tree will be used. 

```{r}
## check accuracy over the PhDArticles data
predicted <- predict(mod3, newdata = PhDArticles)
table(predicted, PhDArticles$Articles)
```

Conditional probabilities (or log-) can be obtained setting `prob = TRUE`:

```{r}
## obtain estimated conditional probabilities in mod3 for first 5 obs
## P(Articles|Gender, Kids, Married, Mentor, Prestige)
predict(mod3, newdata = PhDArticles[1:5,], prob = TRUE)
```

##### Sampling

```{r}
sample_from(mod4, 5)
```
#### Explore the model

##### Model info

```{r}
# Degrees of freedom
df_sevt(mod_full)
df_sevt(mod_indep)

# variables 
variable.names(mod1)

# stages
stages(mod1, "Kids")


# summary
summary(mod1)
```

##### Plot 

```{r}
plot(mod4, main = "Staged tree learned with bj.sevt", 
     cex.label.edges = 0.6, cex.nodes = 1.5)
text(mod4, y = -0.03, cex = 0.7)
```

We can also manually specify colors and avoid plotting 
some stages (e.g. the stages with not-observed situations).
```{r}
plot(stndnaming(mod5, uniq = TRUE, ignore = "NA"), 
     main = "Staged tree learned with stages_hclust 
     (structural zeroes)", 
     col = "stages",
     cex.label.edges = 0.6, cex.nodes = 1.5, ignore = "NA")
text(mod5, y = -0.03, cex = 0.7)
```

###### Barplot

`barplot_stages` permit to easily plot barplots (via `barplot`) 
representing the different probabilities defined for the different
stages of a variable.

```{r}
barplot_stages(mod4, "Kids", legend.text = TRUE)
```


##### Subtrees

A subtree can be extracted, the result is another staged event tree object
in the remaining variables.

```{r}
sub <- subtree(mod4, c(">2", "female"))
plot(sub)
text(sub, y = -0.03, cex = 0.7)
```

#### Comparing models

Check if models are equal.
```{r}
compare_stages(mod1, mod2)

compare_stages(mod1, mod2, method = "hamming", plot = TRUE, 
             cex.label.nodes = 0, cex.label.edges = 0)
text(mod1)

hamming_stages(mod1, mod2)

difftree <- compare_stages(mod1, mod2, method = "stages", plot = FALSE, 
             return.tree = TRUE)

difftree$Married
```

Penalized log-likelihood.
```{r}
BIC(mod_indep, mod_full, mod1, mod2, mod3, mod4, mod5)
```